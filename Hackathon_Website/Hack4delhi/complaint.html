<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Complaint - Delhi Water-Logging System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar" id="main-navbar">
        <!-- Navigation will be dynamically loaded based on role -->
    </nav>

    <!-- Page Header -->
    <section class="dashboard-header">
        <div class="container">
            <h1>üìù Register Civic Complaint</h1>
            <p>Report water-logging, drainage issues, and other civic problems in your area</p>
        </div>
    </section>

    <!-- Complaint Form -->
    <section class="section">
        <div class="container">
            <div class="form-container">
                <div class="form-card">
                    <form id="complaint-form">
                        <!-- Alert for high-risk areas -->
                        <div id="risk-alert" class="alert alert-warning hidden">
                            <span class="alert-icon">‚ö†Ô∏è</span>
                            <div class="alert-content">
                                <div class="alert-title">High Risk Area Detected</div>
                                <div class="alert-message" id="risk-message"></div>
                            </div>
                        </div>

                        <!-- Complaint Category -->
                        <div class="form-group">
                            <label for="category" class="form-label required">Complaint Category</label>
                            <select id="category" name="category" class="form-select" required>
                                <option value="">Select Category</option>
                                <option value="Water Logging">Water Logging</option>
                                <option value="Drain Blockage">Drain Blockage</option>
                                <option value="Sewer Overflow">Sewer Overflow</option>
                                <option value="Garbage Overflow">Garbage Overflow</option>
                                <option value="Road Damage">Road Damage</option>
                                <option value="Streetlight Issue">Streetlight Issue</option>
                                <option value="Encroachment">Encroachment</option>
                            </select>
                        </div>

                        <!-- Zone & Ward Selection -->
                        <div class="form-row">
                            <div class="form-group">
                                <label for="zone" class="form-label required">Zone</label>
                                <select id="zone" name="zone" class="form-select" required>
                                    <option value="">Select Zone</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="ward" class="form-label required">Ward</label>
                                <select id="ward" name="ward" class="form-select" required>
                                    <option value="">Select Ward</option>
                                </select>
                            </div>
                        </div>

                        <!-- Address -->
                        <div class="form-group">
                            <label for="address" class="form-label required">Detailed Address</label>
                            <textarea id="address" name="address" class="form-textarea" rows="3" required placeholder="Enter street name, landmark, and nearby location"></textarea>
                        </div>

                        <!-- Location -->
                        <div class="form-group">
                            <label class="form-label">Location Coordinates</label>
                            <div style="display: flex; gap: 1rem; margin-bottom: 0.5rem;">
                                <button type="button" class="btn btn-primary" onclick="useCurrentLocation()">
                                    üìç Use Current Location
                                </button>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <input type="number" id="lat" name="lat" class="form-input" placeholder="Latitude" step="any">
                                </div>
                                <div class="form-group">
                                    <input type="number" id="lng" name="lng" class="form-input" placeholder="Longitude" step="any">
                                </div>
                            </div>
                            <small class="form-help">Location helps authorities respond faster</small>
                        </div>

                        <!-- Problem Description -->
                        <div class="form-group">
                            <label for="description" class="form-label required">Problem Description</label>
                            <textarea id="description" name="description" class="form-textarea" rows="4" required placeholder="Describe the problem in detail..."></textarea>
                            <small class="form-help">Provide as much detail as possible for faster resolution</small>
                        </div>

                        <!-- Severity -->
                        <div class="form-group">
                            <label class="form-label required">Severity Level</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="severity" value="Low" required>
                                    <span>üü¢ Low - Minor inconvenience</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="severity" value="Medium" required>
                                    <span>üü° Medium - Moderate impact</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="severity" value="High" required>
                                    <span>üî¥ High - Severe problem</span>
                                </label>
                            </div>
                            <small class="form-help" id="severity-suggestion"></small>
                        </div>

                        <!-- Photo Upload -->
                        <div class="form-group">
                            <label class="form-label">Upload Photo (Optional)</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="photo" name="photo" class="file-upload-input" accept="image/*" onchange="previewPhoto(event)">
                                <label for="photo" class="file-upload-label">
                                    <span>üì∑ Choose Photo</span>
                                    <span style="font-size: 0.875rem; color: var(--text-tertiary);">Max size: 5MB</span>
                                </label>
                            </div>
                            <div id="photo-preview" class="file-preview hidden"></div>
                        </div>

                        <!-- Citizen Details -->
                        <h3 style="margin: 2rem 0 1rem;">Citizen Information</h3>

                        <div class="form-group">
                            <label for="citizenName" class="form-label required">Full Name</label>
                            <input type="text" id="citizenName" name="citizenName" class="form-input" required placeholder="Enter your full name">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="citizenPhone" class="form-label required">Phone Number</label>
                                <input type="tel" id="citizenPhone" name="citizenPhone" class="form-input" required placeholder="10-digit mobile number" pattern="[0-9]{10}">
                                <small class="form-help">For status updates via SMS</small>
                            </div>

                            <div class="form-group">
                                <label for="citizenEmail" class="form-label">Email (Optional)</label>
                                <input type="email" id="citizenEmail" name="citizenEmail" class="form-input" placeholder="your@email.com">
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                ‚úÖ Submit Complaint
                            </button>
                            <button type="reset" class="btn btn-secondary" onclick="resetForm()">
                                üîÑ Reset Form
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Success Modal -->
    <div id="success-modal" class="modal-overlay">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-body">
                <div class="success-screen">
                    <div class="success-icon">‚úÖ</div>
                    <h2 class="success-title">Complaint Registered Successfully!</h2>
                    <p class="success-message">Your complaint has been submitted to the authorities</p>
                    
                    <div class="success-details">
                        <div class="success-detail-row">
                            <span class="success-detail-label">Complaint ID:</span>
                            <strong class="success-detail-value" id="success-id">-</strong>
                        </div>
                        <div class="success-detail-row">
                            <span class="success-detail-label">Category:</span>
                            <span class="success-detail-value" id="success-category">-</span>
                        </div>
                        <div class="success-detail-row">
                            <span class="success-detail-label">Ward:</span>
                            <span class="success-detail-value" id="success-ward">-</span>
                        </div>
                        <div class="success-detail-row">
                            <span class="success-detail-label">Status:</span>
                            <span class="success-detail-value">Pending Verification</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="trackComplaint()">
                            üîç Track Now
                        </button>
                        <button class="btn btn-secondary" onclick="downloadReceipt()">
                            üìÑ Download Receipt
                        </button>
                    </div>

                    <button class="btn btn-secondary" onclick="closeSuccessModal()" style="margin-top: 1rem; width: 100%;">
                        ‚úñÔ∏è Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p>&copy; 2026 Delhi Water-Logging Monitoring System</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="auth.js"></script>
    <script src="data.js"></script>
    <script src="script.js"></script>
    <script src="auth.js"></script>
    <script src="complaints.js"></script>
    <script>
        let currentComplaint = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeRoleBasedNavigation('complaint');
            initializeTheme();
            populateZones();
            checkUrlParams();
            
            // Setup form listeners
            document.getElementById('zone').addEventListener('change', updateWards);
            document.getElementById('ward').addEventListener('change', checkWardRisk);
            document.getElementById('complaint-form').addEventListener('submit', handleSubmit);
        });

        function populateZones() {
            const zoneSelect = document.getElementById('zone');
            
            DELHI_ZONES.forEach(zone => {
                const option = document.createElement('option');
                option.value = zone.zone;
                option.textContent = zone.zone;
                zoneSelect.appendChild(option);
            });
        }

        function updateWards() {
            const zoneSelect = document.getElementById('zone');
            const wardSelect = document.getElementById('ward');
            const selectedZone = zoneSelect.value;
            
            wardSelect.innerHTML = '<option value="">Select Ward</option>';
            
            if (selectedZone) {
                const zone = DELHI_ZONES.find(z => z.zone === selectedZone);
                if (zone) {
                    zone.wards.forEach(ward => {
                        const option = document.createElement('option');
                        option.value = ward;
                        option.textContent = ward;
                        wardSelect.appendChild(option);
                    });
                }
            }
        }

        function checkWardRisk() {
            const ward = document.getElementById('ward').value;
            
            if (!ward || typeof enhancedWardsData === 'undefined') return;
            
            const wardData = enhancedWardsData.find(w => w.name === ward);
            
            if (wardData && wardData.riskScore >= 70) {
                const alert = document.getElementById('risk-alert');
                const message = document.getElementById('risk-message');
                
                message.textContent = `${ward} is a high-risk area with flood risk score of ${wardData.riskScore}. Consider reporting as High severity.`;
                alert.classList.remove('hidden');
                
                // Auto-suggest high severity
                const severitySuggestion = document.getElementById('severity-suggestion');
                severitySuggestion.textContent = '‚ö†Ô∏è High severity recommended for this area';
                severitySuggestion.style.color = 'var(--warning-orange)';
            }
        }

        async function useCurrentLocation() {
            try {
                const location = await getCurrentLocation();
                document.getElementById('lat').value = location.lat.toFixed(6);
                document.getElementById('lng').value = location.lng.toFixed(6);
                showToast('Location captured successfully', 'success');
            } catch (error) {
                showToast('Unable to get location: ' + error.message, 'error');
            }
        }

        function previewPhoto(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('photo-preview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const photoFile = document.getElementById('photo').files[0];
            
            try {
                let photoBase64 = null;
                if (photoFile) {
                    photoBase64 = await handleImageUpload(photoFile);
                }
                
                const complaint = await submitComplaint({
                    category: formData.get('category'),
                    ward: formData.get('ward'),
                    zone: formData.get('zone'),
                    address: formData.get('address'),
                    lat: formData.get('lat'),
                    lng: formData.get('lng'),
                    description: formData.get('description'),
                    severity: formData.get('severity'),
                    photoBase64: photoBase64,
                    citizenName: formData.get('citizenName'),
                    citizenPhone: formData.get('citizenPhone'),
                    citizenEmail: formData.get('citizenEmail')
                });
                
                currentComplaint = complaint;
                showSuccessModal(complaint);
                simulateNotification(complaint, 'new_complaint');
                
            } catch (error) {
                showToast('Failed to submit complaint: ' + error.message, 'error');
            }
        }

        function showSuccessModal(complaint) {
            document.getElementById('success-id').textContent = complaint.id;
            document.getElementById('success-category').textContent = complaint.category;
            document.getElementById('success-ward').textContent = complaint.ward;
            document.getElementById('success-modal').classList.add('active');
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').classList.remove('active');
            document.getElementById('complaint-form').reset();
            document.getElementById('photo-preview').classList.add('hidden');
        }

        function trackComplaint() {
            if (currentComplaint) {
                window.location.href = `track.html?id=${currentComplaint.id}`;
            }
        }

        function downloadReceipt() {
            if (currentComplaint) {
                printReceipt(currentComplaint);
            }
        }

        function resetForm() {
            document.getElementById('photo-preview').classList.add('hidden');
            document.getElementById('risk-alert').classList.add('hidden');
        }

        function checkUrlParams() {
            const params = getUrlParams();
            
            if (params.ward) {
                // Find zone for this ward
                const zone = DELHI_ZONES.find(z => z.wards.includes(params.ward));
                if (zone) {
                    document.getElementById('zone').value = zone.zone;
                    updateWards();
                    document.getElementById('ward').value = params.ward;
                    checkWardRisk();
                }
            }
            
            if (params.lat) document.getElementById('lat').value = params.lat;
            if (params.lng) document.getElementById('lng').value = params.lng;
            if (params.category) document.getElementById('category').value = params.category;
        }

        function initializeRoleBasedNavigation(activePage) {
            const session = SessionManager.getSession();
            const navbar = document.getElementById('main-navbar');
            
            if (!session) {
                window.location.href = 'portal.html';
                return;
            }

            if (session.role === 'admin') {
                navbar.innerHTML = `
                    <div class="container">
                        <div class="nav-brand">
                            <span class="nav-logo">üíß</span>
                            <h2>Delhi Water-Logging System - Admin</h2>
                        </div>
                        <div class="nav-content">
                            <div class="nav-links">
                                <a href="admin-home.html">Admin Home</a>
                                <a href="map.html">üó∫Ô∏è Flood Map</a>
                                <a href="complaint.html" class="${activePage === 'complaint' ? 'active' : ''}">üìù Register Complaint</a>
                                <a href="track.html">üîç Track Complaint</a>
                                <a href="my-complaints.html">üìã All Complaints</a>
                                <a href="admin-complaints.html">‚ö° Manage Complaints</a>
                                <a href="authority.html">üèõÔ∏è Authority Dashboard</a>
                            </div>
                            <div class="nav-controls">
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius-full); border: 1px solid var(--border-color);">
                                    <span style="font-size: 1rem;">üèõÔ∏è</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">${session.username || 'Admin'}</span>
                                </div>
                                <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
                                    <span class="icon" id="theme-icon">üåô</span>
                                    <span id="theme-text">Dark</span>
                                </button>
                                <button class="btn btn-danger" onclick="logout()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    üö™ Logout
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                navbar.innerHTML = `
                    <div class="container">
                        <div class="nav-brand">
                            <span class="nav-logo">üíß</span>
                            <h2>Delhi Water-Logging System</h2>
                        </div>
                        <div class="nav-content">
                            <div class="nav-links">
                                <a href="citizen-home.html">Home</a>
                                <a href="map.html">Flood Risk Map</a>
                                <a href="complaint.html" class="${activePage === 'complaint' ? 'active' : ''}">Register Complaint</a>
                                <a href="track.html">Track Complaint</a>
                                <a href="my-complaints.html">My Complaints</a>
                            </div>
                            <div class="nav-controls">
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--bg-secondary); border-radius: var(--radius-full); border: 1px solid var(--border-color);">
                                    <span style="font-size: 1rem;">üë§</span>
                                    <span style="font-size: 0.875rem; font-weight: 600; color: var(--text-primary);">${session.name || 'Citizen'}</span>
                                </div>
                                <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">
                                    <span class="icon" id="theme-icon">üåô</span>
                                    <span id="theme-text">Dark</span>
                                </button>
                                <button class="btn btn-secondary" onclick="logout()" style="padding: 0.5rem 1rem; font-size: 0.875rem;">
                                    üö™ Logout
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>